<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gulimall.ware.dao.WareSkuDao">

    <update id="lockSkuStock">
        UPDATE ware_sku
        SET stock_locked = stock_locked + #{num}
        WHERE sku_id = #{skuId}
          AND ware_id = #{wareId}
          AND (stock - stock_locked) >= #{num}
    </update>
    <update id="unlockStockByOrderSn">
        UPDATE ware_sku ws
            JOIN order_item oi ON ws.sku_id = oi.sku_id
            JOIN order_tbl o ON oi.order_id = o.id
            SET ws.stock_locked = ws.stock_locked - oi.quantity
        WHERE o.order_sn = #{orderSn}
          AND ws.stock_locked >= oi.quantity
    </update>


</mapper>
